rudy@rudys-mbp enoki_exchange % make all
binding to: 127.0.0.1:54665
Jun 14 22:05:10.072 INFO ic-starter. Configuration: ValidatedConfig { replica_path: Some("/Users/rudy/.cache/dfinity/versions/0.9.3/replica"), replica_version: "0.8.0", log_level: Warning, cargo_bin: "cargo", cargo_opts: "", state_dir: "/Users/rudy/ic/enoki/enoki_exchange/.dfx/state/replicated_state", http_listen_addr: 127.0.0.1:0, http_port_file: Some("/Users/rudy/ic/enoki/enoki_exchange/.dfx/replica-configuration/replica-1.port"), metrics_addr: None, provisional_whitelist: Some(All), artifact_pool_dir: "/Users/rudy/ic/enoki/enoki_exchange/.dfx/state/replicated_state/node-100/ic_consensus_pool", crypto_root: "/Users/rudy/ic/enoki/enoki_exchange/.dfx/state/replicated_state/node-100/crypto", state_manager_root: "/Users/rudy/ic/enoki/enoki_exchange/.dfx/state/replicated_state/node-100/state", registry_local_store_path: "/Users/rudy/ic/enoki/enoki_exchange/.dfx/state/replicated_state/ic_registry_local_store", unit_delay: None, initial_notary_delay: Some(600ms), dkg_interval_length: None, detect_consensus_starvation: None, consensus_pool_backend: Some("rocksdb"), subnet_features: SubnetFeatures { ecdsa_signatures: false, canister_sandboxing: false, http_requests: false, bitcoin_testnet_feature: None }, subnet_type: System, _state_dir_holder: None }, Application: starter
Jun 14 22:05:10.073 INFO Initialize replica configuration "/Users/rudy/ic/enoki/enoki_exchange/.dfx/state/replicated_state/ic.json5", Application: starter
Jun 14 22:05:11.098 INFO Executing "/Users/rudy/.cache/dfinity/versions/0.9.3/replica" "--replica-version" "0.8.0" "--config-file" "/Users/rudy/ic/enoki/enoki_exchange/.dfx/state/replicated_state/ic.json5", Application: starter
Jun 14 22:05:11.596 WARN s:juy32-avj3y-s6uyz-ji3bm-qhlb5-ilnbc-4uct5-jo4jq-xlwge-pawke-cqe/n:3pksu-4uzpr-454ry-27epa-2l3v4-2klba-rl53j-e4de5-x5pok-2x2vn-wqe/ic_p2p/advert_utils AdvertRequestBuilder::new(): advert_config = Some(GossipAdvertConfig { best_effort_percentage: 20 })
version: 0.8.1
 Jun 14 16:05:11.653 INFO Log Level: INFO
 Jun 14 16:05:11.654 INFO Starting server. Listening on http://127.0.0.1:8000/
Jun 14 22:05:12.075 WARN s:juy32-avj3y-s6uyz-ji3bm-qhlb5-ilnbc-4uct5-jo4jq-xlwge-pawke-cqe/n:3pksu-4uzpr-454ry-27epa-2l3v4-2klba-rl53j-e4de5-x5pok-2x2vn-wqe/ic_http_handler/status Cannot identify root subnet, will not report root key in status
Using identity: "default".
Creating a wallet canister on the local network.
The wallet canister on the "local" network for user "default" is "rwlgt-iiaaa-aaaaa-aaaaa-cai"
Creating canister "enoki_broker_1"...
"enoki_broker_1" canister created with canister id: "rrkah-fqaaa-aaaaa-aaaaq-cai"
Creating canister "enoki_broker_2"...
"enoki_broker_2" canister created with canister id: "ryjl3-tyaaa-aaaaa-aaaba-cai"
Creating canister "enoki_exchange"...
"enoki_exchange" canister created with canister id: "r7inp-6aaaa-aaaaa-aaabq-cai"
Creating canister "enoki_exchange_assets"...
"enoki_exchange_assets" canister created with canister id: "rkp4c-7iaaa-aaaaa-aaaca-cai"
Creating canister "enoki_liquidity_pool"...
"enoki_liquidity_pool" canister created with canister id: "rno2w-sqaaa-aaaaa-aaacq-cai"
Creating canister "enoki_liquidity_pool_worker"...
"enoki_liquidity_pool_worker" canister created with canister id: "renrk-eyaaa-aaaaa-aaada-cai"
Creating canister "enoki_wrapped_token"...
"enoki_wrapped_token" canister created with canister id: "rdmx6-jaaaa-aaaaa-aaadq-cai"
Creating canister "enoki_wrapped_token_b"...
"enoki_wrapped_token_b" canister created with canister id: "qoctq-giaaa-aaaaa-aaaea-cai"
Creating canister "enoki_wrapped_token_shard_1"...
"enoki_wrapped_token_shard_1" canister created with canister id: "qjdve-lqaaa-aaaaa-aaaeq-cai"
Creating canister "enoki_wrapped_token_shard_2"...
"enoki_wrapped_token_shard_2" canister created with canister id: "qaa6y-5yaaa-aaaaa-aaafa-cai"
Creating canister "enoki_wrapped_token_shard_b_1"...
"enoki_wrapped_token_shard_b_1" canister created with canister id: "qhbym-qaaaa-aaaaa-aaafq-cai"
Creating canister "enoki_wrapped_token_shard_b_2"...
"enoki_wrapped_token_shard_b_2" canister created with canister id: "qsgjb-riaaa-aaaaa-aaaga-cai"
Creating canister "internet_identity"...
"internet_identity" canister created with canister id: "qvhpv-4qaaa-aaaaa-aaagq-cai"
Creating canister "ledger"...
"ledger" canister created with canister id: "q4eej-kyaaa-aaaaa-aaaha-cai"
Creating identity: "minter".
Error: Identity already exists.
Using identity: "minter".
Using identity: "default".
Deploying: ledger
All canisters have already been created.
Building canisters...
Installing canisters...
Creating UI canister on the local network.
The UI canister on the "local" network is "q3fc5-haaaa-aaaaa-aaahq-cai"
Installing code for canister ledger, with canister_id q4eej-kyaaa-aaaaa-aaaha-cai
[Canister q4eej-kyaaa-aaaaa-aaaha-cai] [ledger] init(): minting account is 5b314eb0769b688ec30b77af2f31573aac568bd35d3ce591b95a46503a15cf44
[Canister q4eej-kyaaa-aaaaa-aaaha-cai] [ledger] init(): using default maximum message size: 1048576
Deployed canisters.
URLs:
  Frontend:
    enoki_exchange_assets: http://127.0.0.1:8000/?canisterId=rkp4c-7iaaa-aaaaa-aaaca-cai
  Candid:
    enoki_broker_1: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=rrkah-fqaaa-aaaaa-aaaaq-cai
    enoki_broker_2: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=ryjl3-tyaaa-aaaaa-aaaba-cai
    enoki_exchange: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=r7inp-6aaaa-aaaaa-aaabq-cai
    enoki_liquidity_pool: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=rno2w-sqaaa-aaaaa-aaacq-cai
    enoki_liquidity_pool_worker: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=renrk-eyaaa-aaaaa-aaada-cai
    enoki_wrapped_token: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=rdmx6-jaaaa-aaaaa-aaadq-cai
    enoki_wrapped_token_b: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qoctq-giaaa-aaaaa-aaaea-cai
    enoki_wrapped_token_shard_1: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qjdve-lqaaa-aaaaa-aaaeq-cai
    enoki_wrapped_token_shard_2: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qaa6y-5yaaa-aaaaa-aaafa-cai
    enoki_wrapped_token_shard_b_1: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qhbym-qaaaa-aaaaa-aaafq-cai
    enoki_wrapped_token_shard_b_2: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qsgjb-riaaa-aaaaa-aaaga-cai
    internet_identity: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qvhpv-4qaaa-aaaaa-aaagq-cai
    ledger: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=q4eej-kyaaa-aaaaa-aaaha-cai
Creating canister "enoki_wrapped_token"...
"enoki_wrapped_token" canister was already created and has canister id: "rdmx6-jaaaa-aaaaa-aaadq-cai"
Installing code for canister enoki_wrapped_token, with canister_id rdmx6-jaaaa-aaaaa-aaadq-cai
Creating canister "enoki_wrapped_token_shard_1"...
"enoki_wrapped_token_shard_1" canister was already created and has canister id: "qjdve-lqaaa-aaaaa-aaaeq-cai"
Installing code for canister enoki_wrapped_token_shard_1, with canister_id qjdve-lqaaa-aaaaa-aaaeq-cai
(variant { Ok })
Creating canister "enoki_wrapped_token_shard_2"...
"enoki_wrapped_token_shard_2" canister was already created and has canister id: "qaa6y-5yaaa-aaaaa-aaafa-cai"
Installing code for canister enoki_wrapped_token_shard_2, with canister_id qaa6y-5yaaa-aaaaa-aaafa-cai
(variant { Ok })
Creating canister "enoki_wrapped_token_b"...
"enoki_wrapped_token_b" canister was already created and has canister id: "qoctq-giaaa-aaaaa-aaaea-cai"
Installing code for canister enoki_wrapped_token_b, with canister_id qoctq-giaaa-aaaaa-aaaea-cai
Creating canister "enoki_wrapped_token_shard_b_1"...
"enoki_wrapped_token_shard_b_1" canister was already created and has canister id: "qhbym-qaaaa-aaaaa-aaafq-cai"
Installing code for canister enoki_wrapped_token_shard_b_1, with canister_id qhbym-qaaaa-aaaaa-aaafq-cai
(variant { Ok })
Creating canister "enoki_wrapped_token_shard_b_2"...
"enoki_wrapped_token_shard_b_2" canister was already created and has canister id: "qsgjb-riaaa-aaaaa-aaaga-cai"
Installing code for canister enoki_wrapped_token_shard_b_2, with canister_id qsgjb-riaaa-aaaaa-aaaga-cai
(variant { Ok })
Deploying: internet_identity
All canisters have already been created.
Building canisters...
Installing canisters...
Installing code for canister internet_identity, with canister_id qvhpv-4qaaa-aaaaa-aaagq-cai
Deployed canisters.
URLs:
  Frontend:
    enoki_exchange_assets: http://127.0.0.1:8000/?canisterId=rkp4c-7iaaa-aaaaa-aaaca-cai
  Candid:
    enoki_broker_1: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=rrkah-fqaaa-aaaaa-aaaaq-cai
    enoki_broker_2: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=ryjl3-tyaaa-aaaaa-aaaba-cai
    enoki_exchange: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=r7inp-6aaaa-aaaaa-aaabq-cai
    enoki_liquidity_pool: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=rno2w-sqaaa-aaaaa-aaacq-cai
    enoki_liquidity_pool_worker: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=renrk-eyaaa-aaaaa-aaada-cai
    enoki_wrapped_token: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=rdmx6-jaaaa-aaaaa-aaadq-cai
    enoki_wrapped_token_b: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qoctq-giaaa-aaaaa-aaaea-cai
    enoki_wrapped_token_shard_1: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qjdve-lqaaa-aaaaa-aaaeq-cai
    enoki_wrapped_token_shard_2: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qaa6y-5yaaa-aaaaa-aaafa-cai
    enoki_wrapped_token_shard_b_1: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qhbym-qaaaa-aaaaa-aaafq-cai
    enoki_wrapped_token_shard_b_2: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qsgjb-riaaa-aaaaa-aaaga-cai
    internet_identity: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=qvhpv-4qaaa-aaaaa-aaagq-cai
    ledger: http://127.0.0.1:8000/?canisterId=q3fc5-haaaa-aaaaa-aaahq-cai&id=q4eej-kyaaa-aaaaa-aaaha-cai
+ set -a
+ source .env
++ PRICE_NUMBER_OF_DECIMALS=2
++ NUMBER_OF_BROKERS=2
++ DEPOSIT_FEE_TOKEN_A=30000
++ DEPOSIT_FEE_TOKEN_B=30000
++ LIMIT_ORDER_TAKER_FEE=0.003
++ SWAP_FEE=0.003
++ SWAP_MARKET_MAKER_REWARD=0.4
++ UNDERLYING_TOKEN_ID_A=
++ TOKEN_LOGO_A='test logo'
++ TOKEN_NAME_A='enoki-boosed ICP'
++ TOKEN_SYMBOL_A=eICP
++ TOKEN_DECIMALS_A=12
++ TOKEN_FEE_A=20000
++ UNDERLYING_TOKEN_ID_B=
++ TOKEN_LOGO_B='test logo'
++ TOKEN_NAME_B='enoki-boosed XTC'
++ TOKEN_SYMBOL_B=eXTC
++ TOKEN_DECIMALS_B=12
++ TOKEN_FEE_B=20000
+ set +a
+ '[' -z '' ']'
++ dfx canister id enoki_wrapped_token
+ APP_TOKEN_A=rdmx6-jaaaa-aaaaa-aaadq-cai
+ export APP_TOKEN_A
++ dfx canister id enoki_wrapped_token_b
+ APP_TOKEN_B=qoctq-giaaa-aaaaa-aaaea-cai
+ export APP_TOKEN_B
+ echo 'setting tokens A=rdmx6-jaaaa-aaaaa-aaadq-cai B=qoctq-giaaa-aaaaa-aaaea-cai'
setting tokens A=rdmx6-jaaaa-aaaaa-aaadq-cai B=qoctq-giaaa-aaaaa-aaaea-cai
+ dfx identity use default
Using identity: "default".
+ dfx canister create --all
Creating canister "enoki_broker_1"...
"enoki_broker_1" canister was already created and has canister id: "rrkah-fqaaa-aaaaa-aaaaq-cai"
Creating canister "enoki_broker_2"...
"enoki_broker_2" canister was already created and has canister id: "ryjl3-tyaaa-aaaaa-aaaba-cai"
Creating canister "enoki_exchange"...
"enoki_exchange" canister was already created and has canister id: "r7inp-6aaaa-aaaaa-aaabq-cai"
Creating canister "enoki_exchange_assets"...
"enoki_exchange_assets" canister was already created and has canister id: "rkp4c-7iaaa-aaaaa-aaaca-cai"
Creating canister "enoki_liquidity_pool"...
"enoki_liquidity_pool" canister was already created and has canister id: "rno2w-sqaaa-aaaaa-aaacq-cai"
Creating canister "enoki_liquidity_pool_worker"...
"enoki_liquidity_pool_worker" canister was already created and has canister id: "renrk-eyaaa-aaaaa-aaada-cai"
Creating canister "enoki_wrapped_token"...
"enoki_wrapped_token" canister was already created and has canister id: "rdmx6-jaaaa-aaaaa-aaadq-cai"
Creating canister "enoki_wrapped_token_b"...
"enoki_wrapped_token_b" canister was already created and has canister id: "qoctq-giaaa-aaaaa-aaaea-cai"
Creating canister "enoki_wrapped_token_shard_1"...
"enoki_wrapped_token_shard_1" canister was already created and has canister id: "qjdve-lqaaa-aaaaa-aaaeq-cai"
Creating canister "enoki_wrapped_token_shard_2"...
"enoki_wrapped_token_shard_2" canister was already created and has canister id: "qaa6y-5yaaa-aaaaa-aaafa-cai"
Creating canister "enoki_wrapped_token_shard_b_1"...
"enoki_wrapped_token_shard_b_1" canister was already created and has canister id: "qhbym-qaaaa-aaaaa-aaafq-cai"
Creating canister "enoki_wrapped_token_shard_b_2"...
"enoki_wrapped_token_shard_b_2" canister was already created and has canister id: "qsgjb-riaaa-aaaaa-aaaga-cai"
Creating canister "internet_identity"...
"internet_identity" canister was already created and has canister id: "qvhpv-4qaaa-aaaaa-aaagq-cai"
Creating canister "ledger"...
"ledger" canister was already created and has canister id: "q4eej-kyaaa-aaaaa-aaaha-cai"
+ ./src/enoki_exchange/install.sh
deploying exchange for token pair: rdmx6-jaaaa-aaaaa-aaadq-cai / qoctq-giaaa-aaaaa-aaaea-cai
   Compiling enoki_exchange_shared v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_exchange_shared)
   Compiling enoki_exchange v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_exchange)
    Finished dev [unoptimized + debuginfo] target(s) in 2.90s
     Running `target/debug/enoki_exchange`
Building canisters...
Executing: cargo build --target wasm32-unknown-unknown --release -p enoki_exchange
   Compiling enoki_exchange_shared v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_exchange_shared)
   Compiling enoki_exchange v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_exchange)
    Finished release [optimized] target(s) in 5.38s
Executing: ic-cdk-optimizer -o target/wasm32-unknown-unknown/release/enoki_exchange.wasm target/wasm32-unknown-unknown/release/enoki_exchange.wasm
Original:          3.10 MiB
Stripping Unused Data Segments...
    Size:          1.23 MiB (60.3% smaller)
Execute a binaryen optimization pass on your WASM....
    Size:          1.10 MiB (10.8% smaller)

Final Size: 1.10 MiB (64.6% smaller)
WARNING!
You are about to reinstall the enoki_exchange canister
This will OVERWRITE all the data and code in the canister.

YOU WILL LOSE ALL DATA IN THE CANISTER.");


Do you want to proceed? yes/No
Reinstalling code for canister enoki_exchange, with canister_id r7inp-6aaaa-aaaaa-aaabq-cai
()
+ ./src/enoki_liquidity_pool/install.sh
   Compiling enoki_liquidity_pool v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_liquidity_pool)
    Finished dev [unoptimized + debuginfo] target(s) in 0.67s
     Running `target/debug/enoki_liquidity_pool`
Building canisters...
Executing: cargo build --target wasm32-unknown-unknown --release -p enoki_liquidity_pool
   Compiling enoki_liquidity_pool v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_liquidity_pool)
    Finished release [optimized] target(s) in 2.25s
Executing: ic-cdk-optimizer -o target/wasm32-unknown-unknown/release/enoki_liquidity_pool.wasm target/wasm32-unknown-unknown/release/enoki_liquidity_pool.wasm
Original:          2.70 MiB
Stripping Unused Data Segments...
    Size:          915.80 KiB (66.8% smaller)
Execute a binaryen optimization pass on your WASM....
    Size:          808.66 KiB (11.7% smaller)

Final Size: 808.66 KiB (70.7% smaller)
WARNING!
You are about to reinstall the enoki_liquidity_pool canister
This will OVERWRITE all the data and code in the canister.

YOU WILL LOSE ALL DATA IN THE CANISTER.");


Do you want to proceed? yes/No
Reinstalling code for canister enoki_liquidity_pool, with canister_id rno2w-sqaaa-aaaaa-aaacq-cai
()
+ ./src/enoki_liquidity_pool_worker/install.sh
+++ dirname ./src/enoki_liquidity_pool_worker/install.sh
++ . ./src/enoki_liquidity_pool_worker/build.sh
+++ cargo run --bin enoki_liquidity_pool_worker
++++ dirname ./src/enoki_liquidity_pool_worker/install.sh
   Compiling enoki_liquidity_pool_worker v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_liquidity_pool_worker)
    Finished dev [unoptimized + debuginfo] target(s) in 0.78s
     Running `target/debug/enoki_liquidity_pool_worker`
++ dfx canister create enoki_liquidity_pool
Creating canister "enoki_liquidity_pool"...
"enoki_liquidity_pool" canister was already created and has canister id: "rno2w-sqaaa-aaaaa-aaacq-cai"
++ dfx canister create enoki_liquidity_pool_worker
Creating canister "enoki_liquidity_pool_worker"...
"enoki_liquidity_pool_worker" canister was already created and has canister id: "renrk-eyaaa-aaaaa-aaada-cai"
++ dfx build enoki_liquidity_pool_worker
Building canisters...
Executing: cargo build --target wasm32-unknown-unknown --release -p enoki_liquidity_pool_worker
   Compiling enoki_liquidity_pool_worker v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_liquidity_pool_worker)
    Finished release [optimized] target(s) in 2.63s
Executing: ic-cdk-optimizer -o target/wasm32-unknown-unknown/release/enoki_liquidity_pool_worker.wasm target/wasm32-unknown-unknown/release/enoki_liquidity_pool_worker.wasm
Original:          2.83 MiB
Stripping Unused Data Segments...
    Size:          1.01 MiB (64.5% smaller)
Execute a binaryen optimization pass on your WASM....
    Size:          911.60 KiB (11.4% smaller)

Final Size: 911.60 KiB (68.6% smaller)
+++ dfx canister id enoki_liquidity_pool
++ MANAGER_ID='principal "rno2w-sqaaa-aaaaa-aaacq-cai"'
++ yes yes
++ dfx canister install enoki_liquidity_pool_worker
Installing code for canister enoki_liquidity_pool_worker, with canister_id renrk-eyaaa-aaaaa-aaada-cai
++ dfx canister call enoki_liquidity_pool_worker finishInit '(principal "rno2w-sqaaa-aaaaa-aaacq-cai")'
()
+++ dfx canister id enoki_liquidity_pool_worker
++ dfx canister call enoki_liquidity_pool initWorker '(principal "renrk-eyaaa-aaaaa-aaada-cai")'
()
++ dfx canister call enoki_exchange initPool '(principal "rno2w-sqaaa-aaaaa-aaacq-cai")'
()
+ ./src/enoki_broker/install.sh
+++ dirname ./src/enoki_broker/install.sh
++ . ./src/enoki_broker/build.sh
+++ cargo run --bin enoki_broker
++++ dirname ./src/enoki_broker/install.sh
   Compiling enoki_broker v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_broker)
    Finished dev [unoptimized + debuginfo] target(s) in 1.24s
     Running `target/debug/enoki_broker`
+++ dfx canister id enoki_exchange
++ MANAGER_ID='principal "r7inp-6aaaa-aaaaa-aaabq-cai"'
++ CANISTER_NAME=enoki_broker
++ i=1
++ num_brokers=2
++ '[' 1 -le 2 ']'
++ dfx build enoki_broker_1
Building canisters...
Executing: cargo build --target wasm32-unknown-unknown --release -p enoki_broker
   Compiling enoki_broker v0.1.0 (/Users/rudy/ic/enoki/enoki_exchange/src/enoki_broker)
    Finished release [optimized] target(s) in 5.29s
Executing: ic-cdk-optimizer -o target/wasm32-unknown-unknown/release/enoki_broker.wasm target/wasm32-unknown-unknown/release/enoki_broker.wasm
Original:          3.43 MiB
Stripping Unused Data Segments...
    Size:          1.52 MiB (55.8% smaller)
Execute a binaryen optimization pass on your WASM....
    Size:          1.35 MiB (10.7% smaller)

Final Size: 1.35 MiB (60.5% smaller)
++ yes yes
++ dfx canister install enoki_broker_1 -m=reinstall
WARNING!
You are about to reinstall the enoki_broker_1 canister
This will OVERWRITE all the data and code in the canister.

YOU WILL LOSE ALL DATA IN THE CANISTER.");


Do you want to proceed? yes/No
Reinstalling code for canister enoki_broker_1, with canister_id rrkah-fqaaa-aaaaa-aaaaq-cai
++ dfx canister call enoki_broker_1 finishInit '(principal "r7inp-6aaaa-aaaaa-aaabq-cai")'
()
+++ dfx canister id enoki_broker_1
++ dfx canister call enoki_exchange addBroker '(principal "rrkah-fqaaa-aaaaa-aaaaq-cai")'
()
++ true 1
++ '[' 2 -le 2 ']'
++ dfx build enoki_broker_2
Building canisters...
Executing: cargo build --target wasm32-unknown-unknown --release -p enoki_broker
    Finished release [optimized] target(s) in 0.04s
Executing: ic-cdk-optimizer -o target/wasm32-unknown-unknown/release/enoki_broker.wasm target/wasm32-unknown-unknown/release/enoki_broker.wasm
Original:          3.43 MiB
Stripping Unused Data Segments...
    Size:          1.52 MiB (55.8% smaller)
Execute a binaryen optimization pass on your WASM....
    Size:          1.35 MiB (10.7% smaller)

Final Size: 1.35 MiB (60.5% smaller)
++ yes yes
++ dfx canister install enoki_broker_2 -m=reinstall
WARNING!
You are about to reinstall the enoki_broker_2 canister
This will OVERWRITE all the data and code in the canister.

YOU WILL LOSE ALL DATA IN THE CANISTER.");


Do you want to proceed? yes/No
Reinstalling code for canister enoki_broker_2, with canister_id ryjl3-tyaaa-aaaaa-aaaba-cai
++ dfx canister call enoki_broker_2 finishInit '(principal "r7inp-6aaaa-aaaaa-aaabq-cai")'
()
+++ dfx canister id enoki_broker_2
++ dfx canister call enoki_exchange addBroker '(principal "ryjl3-tyaaa-aaaaa-aaaba-cai")'
()
++ true 2
++ '[' 3 -le 2 ']'
setting tokens A=rdmx6-jaaaa-aaaaa-aaadq-cai B=qoctq-giaaa-aaaaa-aaaea-cai
start creating users
Creating identity: "pooler1".
Error: Identity already exists.
Creating identity: "pooler2".
Error: Identity already exists.
[info]  pooler1: mitqm-w5s2x-yz24l-thb4p-r6zvj-ze3lh-yse67-q4edt-2l5dr-4oyus-hqe
[info]  pooler2: qiif4-tyjtb-6gz4q-bckmi-x4v3s-xa53a-jtyqw-cwh3e-ummiv-34odo-2qe
passed creating users

start fund users
Using identity: "default".
[info]  pooler1 assigned shards: qaa6y-5yaaa-aaaaa-aaafa-cai / qsgjb-riaaa-aaaaa-aaaga-cai
[info]  pooler2 assigned shards: qjdve-lqaaa-aaaaa-aaaeq-cai / qhbym-qaaaa-aaaaa-aaafq-cai
()
()
()
()
passed fund users

start deposit funds on LP
()
()
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] increased user mitqm-w5s2x-yz24l-thb4p-r6zvj-ze3lh-yse67-q4edt-2l5dr-4oyus-hqe pending liquidity by TokenAmount { token: TokenA, amount: 699_980_000 }
()
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] increased user mitqm-w5s2x-yz24l-thb4p-r6zvj-ze3lh-yse67-q4edt-2l5dr-4oyus-hqe pending liquidity by TokenAmount { token: TokenB, amount: 699_980_000 }
()
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] increased user qiif4-tyjtb-6gz4q-bckmi-x4v3s-xa53a-jtyqw-cwh3e-ummiv-34odo-2qe pending liquidity by TokenAmount { token: TokenA, amount: 999_980_000 }
()
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] locking 3 pending add and 0 pending remove
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: applying traded: LiquidityTrades { increased: LiquidityAmount { token_a: 0, token_b: 0 }, decreased: LiquidityAmount { token_a: 0, token_b: 0 } }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity before applying traded: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity after applying traded: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: adding more total liquidity: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: removing total liquidity: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] there are now 3 and 0 pending add and remove liquidity positions
(null)
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] started exchange sync
[Canister rno2w-sqaaa-aaaaa-aaacq-cai] [lp] updated liquidity: LiquidityAmount { token_a: 1_699_960_000, token_b: 699_980_000 } to add, LiquidityAmount { token_a: 0, token_b: 0 } to remove
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] got liquidity: RequestForNewLiquidityTarget { target: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }, extra_liquidity_available: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 } }
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] got 0 new orders and 0 to cancel
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] completed orders: {}
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] submitting orders to brokers...
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] new liquidity target: RequestForNewLiquidityTarget { target: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }, extra_liquidity_available: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 } }. Existing available: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister ryjl3-tyaaa-aaaaa-aaaba-cai] [broker] new liquidity target: RequestForNewLiquidityTarget { target: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }, extra_liquidity_available: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 } }. Existing available: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] current available liquidity: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }
[Canister ryjl3-tyaaa-aaaaa-aaaba-cai] [broker] current available liquidity: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] updating changes in liquidity...
[Canister rno2w-sqaaa-aaaaa-aaacq-cai] [lp] resolved liquidity: LiquidityAmount { token_a: 1_699_960_000, token_b: 699_980_000 } added, LiquidityAmount { token_a: 0, token_b: 0 } removed, LiquidityTrades { increased: LiquidityAmount { token_a: 0, token_b: 0 }, decreased: LiquidityAmount { token_a: 0, token_b: 0 } } traded
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] end exchange sync
()
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] locking 0 pending add and 0 pending remove
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: applying traded: LiquidityTrades { increased: LiquidityAmount { token_a: 0, token_b: 0 }, decreased: LiquidityAmount { token_a: 0, token_b: 0 } }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity before applying traded: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity after applying traded: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: adding more total liquidity: LiquidityAmount { token_a: 1_699_960_000, token_b: 699_980_000 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity for user mitqm-w5s2x-yz24l-thb4p-r6zvj-ze3lh-yse67-q4edt-2l5dr-4oyus-hqe was successfully added: 699_980_000 TokenA
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity for user mitqm-w5s2x-yz24l-thb4p-r6zvj-ze3lh-yse67-q4edt-2l5dr-4oyus-hqe was successfully added: 699_980_000 TokenB
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity for user qiif4-tyjtb-6gz4q-bckmi-x4v3s-xa53a-jtyqw-cwh3e-ummiv-34odo-2qe was successfully added: 999_980_000 TokenA
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: removing total liquidity: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] there are now 0 and 0 pending add and remove liquidity positions
(null)
[info]  pooler 1 liquidity: (record { token_a = 699_980_000 : nat; token_b = 699_980_000 : nat })
[info]  pooler 2 liquidity: (record { token_a = 999_980_000 : nat; token_b = 0 : nat })
passed deposit funds on LP

3/3 tests passed

setting tokens A=rdmx6-jaaaa-aaaaa-aaadq-cai B=qoctq-giaaa-aaaaa-aaaea-cai
start creating users
Creating identity: "trader1".
Error: Identity already exists.
Creating identity: "trader2".
Error: Identity already exists.
Creating identity: "swapper".
Error: Identity already exists.
[info]  trader1: drkgy-5t46i-acoxn-i7gdb-g7bxp-j5smt-uzrem-a2v6i-ii5ho-grwxz-pqe
[info]  trader2: n3ktv-alexj-dbetk-hc7an-frdhw-unsh6-nehie-lca7x-u7v67-jclks-oqe
[info]  swapper: alm3v-cpz7a-sauz7-pu2wm-oslbp-4np3t-ybmvy-zn52p-rc5qo-wscru-oae
passed creating users

start fund users
Using identity: "default".
[info]  trader1 assigned shards: qaa6y-5yaaa-aaaaa-aaafa-cai / qsgjb-riaaa-aaaaa-aaaga-cai
[info]  trader2 assigned shards: qjdve-lqaaa-aaaaa-aaaeq-cai / qhbym-qaaaa-aaaaa-aaafq-cai
[info]  swapper assigned shards: qjdve-lqaaa-aaaaa-aaaeq-cai / qhbym-qaaaa-aaaaa-aaafq-cai
()
()
()
()
()
()
passed fund users

start submit limit trades
()
()
()
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] order accepted: ProcessedOrderInput {user: drkgy-5t46i-acoxn-i7gdb-g7bxp-j5smt-uzrem-a2v6i-ii5ho-grwxz-pqe, side: Sell, quantity: Nat(399980000), OnlyMaker, limit_price_in_b: 600, expiration_time:














































































".dfx/local/wallets.json" [noeol] 7L, 93B
None}
()
[Canister ryjl3-tyaaa-aaaaa-aaaba-cai] [broker] order accepted: ProcessedOrderInput {user: n3ktv-alexj-dbetk-hc7an-frdhw-unsh6-nehie-lca7x-u7v67-jclks-oqe, side: Sell, quantity: Nat(299980000), OnlyMaker, limit_price_in_b: 595, expiration_time: None}
()
[Canister ryjl3-tyaaa-aaaaa-aaaba-cai] [broker] order accepted: ProcessedOrderInput {user: n3ktv-alexj-dbetk-hc7an-frdhw-unsh6-nehie-lca7x-u7v67-jclks-oqe, side: Buy, quantity: Nat(299980000), OnlyMaker, limit_price_in_b: 590, expiration_time: None}
()
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] started exchange sync
[Canister rno2w-sqaaa-aaaaa-aaacq-cai] [lp] updated liquidity: LiquidityAmount { token_a: 0, token_b: 0 } to add, LiquidityAmount { token_a: 0, token_b: 0 } to remove
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] got liquidity: RequestForNewLiquidityTarget { target: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }, extra_liquidity_available: LiquidityAmount { token_a: 0, token_b: 0 } }
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] got 3 new orders and 0 to cancel
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] completed orders: {}
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] submitting orders to brokers...
[Canister ryjl3-tyaaa-aaaaa-aaaba-cai] [broker] new liquidity target: RequestForNewLiquidityTarget { target: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }, extra_liquidity_available: LiquidityAmount { token_a: 0, token_b: 0 } }. Existing available: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }
[Canister ryjl3-tyaaa-aaaaa-aaaba-cai] [broker] current available liquidity: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] new liquidity target: RequestForNewLiquidityTarget { target: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }, extra_liquidity_available: LiquidityAmount { token_a: 0, token_b: 0 } }. Existing available: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] current available liquidity: LiquidityAmount { token_a: 849_980_000, token_b: 349_990_000 }
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] updating changes in liquidity...
[Canister rno2w-sqaaa-aaaaa-aaacq-cai] [lp] resolved liquidity: LiquidityAmount { token_a: 0, token_b: 0 } added, LiquidityAmount { token_a: 0, token_b: 0 } removed, LiquidityTrades { increased: LiquidityAmount { token_a: 0, token_b: 0 }, decreased: LiquidityAmount { token_a: 0, token_b: 0 } } traded
[Canister r7inp-6aaaa-aaaaa-aaabq-cai] [exchange] end exchange sync
()
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] locking 0 pending add and 0 pending remove
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: applying traded: LiquidityTrades { increased: LiquidityAmount { token_a: 0, token_b: 0 }, decreased: LiquidityAmount { token_a: 0, token_b: 0 } }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity before applying traded: LiquidityAmount { token_a: 1_699_960_000, token_b: 699_980_000 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] liquidity after applying traded: LiquidityAmount { token_a: 1_699_960_000, token_b: 699_980_000 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: adding more total liquidity: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] resolved: removing total liquidity: LiquidityAmount { token_a: 0, token_b: 0 }
[Canister renrk-eyaaa-aaaaa-aaada-cai] [worker] there are now 0 and 0 pending add and remove liquidity positions
(null)
[info]  before swap balance A: (1_000_000_000 : nat), B: (1_000_000_000 : nat)
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] order accepted: ProcessedOrderInput {user: alm3v-cpz7a-sauz7-pu2wm-oslbp-4np3t-ybmvy-zn52p-rc5qo-wscru-oae, side: Sell, quantity: Nat(49980000), OnlyTaker, limit_price_in_b: 585, expiration_time: None}
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] swap -> sending user alm3v-cpz7a-sauz7-pu2wm-oslbp-4np3t-ybmvy-zn52p-rc5qo-wscru-oae TokenB Nat(294882000)
[Canister qhbym-qaaaa-aaaaa-aaafq-cai] Panicked at 'called `Result::unwrap()` on an `Err` value: AccountDoesNotExist { shard: "qhbym-qaaaa-aaaaa-aaafq-cai", user: "rrkah-fqaaa-aaaaa-aaaaq-cai" }', src/enoki_wrapped_token_shard/src/balances.rs:281:10
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] Panicked at '[broker] error with swap: Callback error: Error in callback (code CanisterError): IC0503: Canister qhbym-qaaaa-aaaaa-aaafq-cai trapped explicitly: Panicked at 'called `Result::unwrap()` on an `Err` value: AccountDoesNotExist { shard: "qhbym-qaaaa-aaaaa-aaafq-cai", user: "rrkah-fqaaa-aaaaa-aaaaq-cai" }', src/enoki_wrapped_token_shard/src/balances.rs:281:10', src/enoki_broker/src/liquidity.rs:125:9
[Canister qaa6y-5yaaa-aaaaa-aaafa-cai] Panicked at 'called `Result::unwrap()` on an `Err` value: TransferCallbackError("Error in callback (code CanisterError): IC0503: Canister rrkah-fqaaa-aaaaa-aaaaq-cai trapped explicitly: Panicked at '[broker] error with swap: Callback error: Error in callback (code CanisterError): IC0503: Canister qhbym-qaaaa-aaaaa-aaafq-cai trapped explicitly: Panicked at 'called `Result::unwrap()` on an `Err` value: AccountDoesNotExist { shard: \"qhbym-qaaaa-aaaaa-aaafq-cai\", user: \"rrkah-fqaaa-aaaaa-aaaaq-cai\" }', src/enoki_wrapped_token_shard/src/balances.rs:281:10', src/enoki_broker/src/liquidity.rs:125:9")', src/enoki_wrapped_token_shard/src/balances.rs:351:6
Error: The Replica returned an error: code 5, message: "Canister qaa6y-5yaaa-aaaaa-aaafa-cai trapped explicitly: Panicked at 'called `Result::unwrap()` on an `Err` value: TransferCallbackError("Error in callback (code CanisterError): IC0503: Canister rrkah-fqaaa-aaaaa-aaaaq-cai trapped explicitly: Panicked at '[broker] error with swap: Callback error: Error in callback (code CanisterError): IC0503: Canister qhbym-qaaaa-aaaaa-aaafq-cai trapped explicitly: Panicked at 'called `Result::unwrap()` on an `Err` value: AccountDoesNotExist { shard: \"qhbym-qaaaa-aaaaa-aaafq-cai\", user: \"rrkah-fqaaa-aaaaa-aaaaq-cai\" }', src/enoki_wrapped_token_shard/src/balances.rs:281:10', src/enoki_broker/src/liquidity.rs:125:9")', src/enoki_wrapped_token_shard/src/balances.rs:351:6"
ERROR at line 76
[info]  after swap 1 balance A: (950_000_000 : nat), B: (1_000_000_000 : nat)
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] order accepted: ProcessedOrderInput {user: alm3v-cpz7a-sauz7-pu2wm-oslbp-4np3t-ybmvy-zn52p-rc5qo-wscru-oae, side: Buy, quantity: Nat(49980000), OnlyTaker, limit_price_in_b: 610, expiration_time: None}
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] [broker] swap -> sending user alm3v-cpz7a-sauz7-pu2wm-oslbp-4np3t-ybmvy-zn52p-rc5qo-wscru-oae TokenA Nat(8400000)
[Canister qjdve-lqaaa-aaaaa-aaaeq-cai] Panicked at 'called `Result::unwrap()` on an `Err` value: AccountDoesNotExist { shard: "qjdve-lqaaa-aaaaa-aaaeq-cai", user: "rrkah-fqaaa-aaaaa-aaaaq-cai" }', src/enoki_wrapped_token_shard/src/balances.rs:281:10
[Canister rrkah-fqaaa-aaaaa-aaaaq-cai] Panicked at '[broker] error with swap: Callback error: Error in callback (code CanisterError): IC0503: Canister qjdve-lqaaa-aaaaa-aaaeq-cai trapped explicitly: Panicked at 'called `Result::unwrap()` on an `Err` value: AccountDoesNotExist { shard: "qjdve-lqaaa-aaaaa-aaaeq-cai", user: "rrkah-fqaaa-aaaaa-aaaaq-cai" }', src/enoki_wrapped_token_shard/src/balances.rs:281:10', src/enoki_broker/src/liquidity.rs:125:9
[Canister qsgjb-riaaa-aaaaa-aaaga-cai] Panicked at 'called `Result::unwrap()` on an `Err` value: TransferCallbackError("Error in callback (code CanisterError): IC0503: Canister rrkah-fqaaa-aaaaa-aaaaq-cai trapped explicitly: Panicked at '[broker] error with swap: Callback error: Error in callback (code CanisterError): IC0503: Canister qjdve-lqaaa-aaaaa-aaaeq-cai trapped explicitly: Panicked at 'called `Result::unwrap()` on an `Err` value: AccountDoesNotExist { shard: \"qjdve-lqaaa-aaaaa-aaaeq-cai\", user: \"rrkah-fqaaa-aaaaa-aaaaq-cai\" }', src/enoki_wrapped_token_shard/src/balances.rs:281:10', src/enoki_broker/src/liquidity.rs:125:9")', src/enoki_wrapped_token_shard/src/balances.rs:351:6
^CStopping the replica...
make: *** [test] Interrupt: 2

rudy@rudys-mbp enoki_exchange % Stopped.
Stopping icx-proxy...
Stopped.
